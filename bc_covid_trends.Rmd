---
title: "BC Covid Trends"
author: "Jens von Bergmann"
date: "Last updated at `r format(Sys.time(), '%d %B, %Y - %H:%M',tz='America/Vancouver')`"
output: rmarkdown::github_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.retina = 2,
	dpi = 150,
	fig.width = 7,
	fig.height = 5
)
library(ggplot2)
library(readr)
library(tidyr)
library(dplyr)
library(ggrepel)
library(ggtext)
library(here)
library(sanzo)
library(CanCovidData)

source(here("R/helpers.R"))

major_restrictions <- c("2020-03-18"="Phase 1","2020-11-07"="No private\ngatherings","2020-11-19"="Masks in stores\nTravel discouraged")
major_restriction_labels <- c("2020-03-18"="Phase 1","2020-11-07"="No private\ngatherings","2020-11-19"="Masks in stores\nTravel discouraged")
major_restrictions_y <- c("2020-03-18"=1,"2020-11-07"=0.1,"2020-11-19"=0.3)
minor_restrictions <- c("2020-03-11","2020-03-12","2020-03-16","2020-03-17",
                        "2020-03-21","2020-03-22","2020-03-26","2020-04-18",
                        "2020-06-18","2020-08-21","2020-09-08","2020-10-26")
major_reopenings <- c("2020-05-19"="Phase 2","2020-06-24"="Phase 3")
minor_reopenings <- c("2020-05-14","2020-06-01","2020-06-08",
                      "2020-06-30","2020-07-02","2020-09-10","2020-12-15")

restriction_markers <- function(major_size=1,minor_size=0.5){
  list(
    geom_vline(xintercept = as.Date(minor_reopenings),
               linetype="dashed",color="darkgreen",size=minor_size),
    geom_vline(xintercept = as.Date(names(major_reopenings)),linetype="dashed",color="darkgreen",size=major_size),
    geom_vline(xintercept = as.Date(names(major_restrictions)),linetype="dashed",color="brown",size=major_size),
    geom_vline(xintercept = as.Date(minor_restrictions),
               linetype="dashed",color="brown",size=minor_size)
)}

full_labels <- function(label_y,
                        major_restriction_labels = c("2020-03-18"="Phase 1","2020-11-07"="No private\ngatherings"),
                        major_restrictions_y = c(1,0.15)){
  c(restriction_markers(),list(
    geom_label(data = tibble(Date=as.Date(names(major_reopenings)),
                             count=c(label_y,label_y),
                             label=as.character(major_reopenings)),
               aes(label=label),size=4,alpha=0.7,color="darkgreen"),
    geom_label(data = tibble(Date=as.Date(names(major_restriction_labels)),
                             label=as.character(major_restriction_labels),
                             count=as.numeric(major_restrictions_y)),
               aes(label=label),size=4,alpha=0.7,color="brown")
  ))
}

ha_colours <- setNames(c(trios$c157,trios$c149),
                       c("Fraser","Rest of BC","Vancouver Coastal" , "Vancouver Island", "Interior", "Northern"))

```


This notebook is intended to give a daily overview over BC Covid Trends. It utilizes a (multiplicative) STL decomposition to esimate a seasonally adjusted time series controlling for the strong weekly pattern in the COVID-19 case data and the trend line. For details check the [R notebook in this GitHub repo](https://github.com/mountainMath/BCCovidSnippets/blob/main/bc_covid_trends.Rmd).

## Overall BC Trend

```{r bc-trend}
data <- get_british_columbia_case_data() %>%
  #filter(`Health Authority` %in% c("Vancouver Coastal","Fraser")) %>%
  count(Date=`Reported Date`,name="Cases") %>%
  filter(Date>=as.Date("2020-03-01")) %>%
  mutate(Trend=extract_stl_trend_m(Cases),
         Seasonal=extract_stl_seasonal_m(Cases)) %>%
  mutate(Cleaned=Cases/Seasonal) %>%
  cbind(compute_rolling_exp_fit(.$Trend))

label_y <- max(data$Cases) * 0.9

g <- data %>% 
  pivot_longer(c("Cases","Trend","Cleaned"),names_to="type",values_to="count") %>%
  #filter(Date>=as.Date("2020-11-01")) %>%
  ggplot(aes(x = Date, y = count)) + 
  geom_point(data=~filter(.,type=="Cases"),color="grey",size=0.5) +
  geom_line(data=~filter(.,type=="Cleaned"),color="grey",size=0.5,alpha=0.5) +
  geom_line(data=~filter(.,type=="Trend"),color="black",size=1) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_x_date(breaks="month",labels=function(d)strftime(d,"%b")) +
  full_labels(label_y,major_restriction_labels=major_restriction_labels,
              major_restrictions_y=major_restrictions_y*label_y) +
  labs(title=paste0("Covid-19 daily new cases in British Columbia (up to ",strftime(max(data$Date),"%a %b %d"),")"),
       subtitle="Timeline of <b style='color:#A52A2A;'>closure</b> and <b style='color:#006400;'>reopening</b> events",
       x=NULL,y=NULL,color=NULL,caption="MountainMath, Data: BCCDC") +
  theme(plot.subtitle = element_markdown())
g
#r<-graph_to_s3(g,"bccovid","bc-trend.png",width=knitr::opts_chunk$get('fig.width'),height=knitr::opts_chunk$get('fig.height'))
```


## Main Health Authority Trends

```{r main-ha-trend}
pop_data <- read_csv(here("data/ha_pop.csv")) %>%
  select(`Health Authority`,Population=Total)

data <- get_british_columbia_case_data() %>%
  mutate(HA=ifelse(`Health Authority` %in% c("Fraser","Vancouver Coastal"),`Health Authority`,"Rest of BC")) %>%
  #mutate(HA=`Health Authority`) %>%
  count(Date=`Reported Date`,HA, name="Cases") %>%
  filter(Date>=as.Date("2020-03-01")) %>%
  group_by(HA) %>%
  mutate(Trend=extract_stl_trend_m(Cases),
         Seasonal=extract_stl_seasonal_m(Cases)) %>%
  mutate(Cleaned=Cases/Seasonal) %>%
  left_join(read_csv(here("data/ha_pop.csv")) %>%
              filter(`Health Authority` != "British Columbia") %>%
              mutate(HA=ifelse(`Health Authority` %in% c("Fraser","Vancouver Coastal"),
                               `Health Authority`,"Rest of BC")) %>%
              group_by(HA) %>%
              summarize(Population=sum(Total), .groups="drop"), by="HA") %>%
  ungroup() %>%
  mutate_at(c("Cases","Cleaned","Trend"),function(d)d/.$Population*100000)

label_y <- max(data$Cases) * 0.9

g <- data %>% 
  pivot_longer(c("Cases","Trend","Cleaned"),names_to="type",values_to="count") %>%
  ggplot(aes(x = Date, y = count)) + 
  geom_point(data=~filter(.,type=="Cases"),size=0.5,alpha=0.25,aes(color=HA,group=HA)) +
  geom_line(data=~filter(.,type=="Cleaned"),size=0.5,alpha=0.25,aes(color=HA,group=HA)) +
  geom_line(data=~filter(.,type=="Trend"),aes(color=HA,group=HA),size=1) +
  theme_bw() +
  scale_x_date(breaks="month",labels=function(d)strftime(d,"%b")) +
  theme(legend.position = "bottom") +
  full_labels(label_y,
              major_restriction_labels=c("2020-03-18"="Phase 1"),
              major_restrictions_y=label_y) +
  scale_color_manual(values=ha_colours) +
  labs(title=paste0("Covid-19 daily new cases in British Columbia (up to ",strftime(max(data$Date),"%a %b %d"),")"),
       subtitle="Timeline of <b style='color:#A52A2A;'>closure</b> and <b style='color:#006400;'>reopening</b> events",
       x=NULL,y="Daily cases per 100k population",color=NULL,caption="MountainMath, Data: BCCDC, BC Stats") +
  theme(plot.subtitle = element_markdown()) 

g
#r<-graph_to_s3(g,"bccovid","main-ha-trend.png",width=knitr::opts_chunk$get('fig.width'),height=knitr::opts_chunk$get('fig.height'))
```

## Health Authority Trends

```{r ha-trend}
pop_data <- read_csv(here("data/ha_pop.csv")) %>%
  select(`Health Authority`,Population=Total)

data <- get_british_columbia_case_data() %>%
  mutate(HA=`Health Authority`) %>%
  filter(HA!="Out of Canada") %>%
  #mutate(HA=ifelse(`Health Authority` %in% c("Fraser","Vancouver Coastal"),`Health Authority`,"Rest of BC")) %>%
  #mutate(HA=`Health Authority`) %>%
  count(Date=`Reported Date`,HA, name="Cases") %>%
  filter(Date>=as.Date("2020-03-01")) %>%
  #expand(Date=(.)$Date %>% unique,HA,Cases) %>%
  #mutate(Cases=coalesce(Cases,0)) %>%
  group_by(HA) %>%
  mutate(Trend=extract_stl_trend_m(Cases),
         Seasonal=extract_stl_seasonal_m(Cases)) %>%
  mutate(Cleaned=Cases/Seasonal) %>%
  left_join(read_csv(here("data/ha_pop.csv")) %>%
              filter(`Health Authority` != "British Columbia") %>%
              mutate(HA=`Health Authority`) %>%
              group_by(HA) %>%
              summarize(Population=sum(Total), .groups="drop"), by="HA") %>%
  ungroup() %>%
  mutate_at(c("Cases","Cleaned","Trend"),function(d)d/.$Population*100000)

label_y <- max(data$Cases) * 0.9

g <- data %>% 
  pivot_longer(c("Cases","Trend","Cleaned"),names_to="type",values_to="count") %>%
  ggplot(aes(x = Date, y = count)) + 
  geom_point(data=~filter(.,type=="Cases"),size=0.5,alpha=0.25,aes(color=HA,group=HA)) +
  geom_line(data=~filter(.,type=="Cleaned"),size=0.5,alpha=0.25,aes(color=HA,group=HA)) +
  geom_line(data=~filter(.,type=="Trend"),aes(color=HA,group=HA),size=1) +
  theme_bw() +
  scale_x_date(breaks="month",labels=function(d)strftime(d,"%b")) +
  theme(legend.position = "bottom") +
  full_labels(label_y,
              major_restriction_labels=c("2020-03-18"="Phase 1"),
              major_restrictions_y=label_y) +
  scale_color_manual(values=ha_colours) +
  labs(title=paste0("Covid-19 daily new cases in British Columbia (up to ",strftime(max(data$Date),"%a %b %d"),")"),
       subtitle="Timeline of <b style='color:#A52A2A;'>closure</b> and <b style='color:#006400;'>reopening</b> events",
       x=NULL,y="Daily cases per 100k population",color=NULL,caption="MountainMath, Data: BCCDC, BC Stats") +
  theme(plot.subtitle = element_markdown())

g
#r<-graph_to_s3(g,"bccovid","ha-trend.png",width=knitr::opts_chunk$get('fig.width'),height=knitr::opts_chunk$get('fig.height'))
```

## Health Region Trends

```{r hr-trend}
pop_data <- read_csv(here("data/hr_pop.csv")) %>%
  select(HR_UID=Region,HR=`Health Service Delivery Area`,Population=Total)

data <- get_british_columbia_hr_case_data() %>%
  rename(HA=`Health Authority`,HR=`Health Region`) %>%
  filter(!(HA %in% c("Out of Canada","All")),!(HR %in% c("All","Unknown"))) %>%
  filter(Date>=as.Date("2020-03-01")) %>%
  group_by(HR,HA) %>%
  mutate(Trend=extract_stl_trend_m(Cases+1),
         Seasonal=extract_stl_seasonal_m(Cases+1)) %>%
  mutate(Cleaned=Cases/Seasonal-1) %>%
  left_join(read_csv(here("data/ha_pop.csv")) %>%
              select(HA=`Health Authority`,HA_Population=Total), by="HA") %>%
  left_join(pop_data, by="HR") %>%
  mutate(Population=coalesce(Population,HA_Population)) %>%
  ungroup() %>%
  mutate(Cases_0=Cases,Trend_0=Trend,Cleand_0=Cleaned) %>%
  mutate_at(c("Cases","Cleaned","Trend"),function(d)d/.$Population*100000)

label_y <- max(data$Cases) * 0.9 

g <- data %>% 
  filter(!(HR %in% c("All","Unknown"))) %>%
  pivot_longer(c("Cases","Trend","Cleaned"),names_to="type",values_to="count") %>%
  ggplot(aes(x = Date, y = count)) + 
  #geom_point(data=~filter(.,type=="Cases"),size=0.5,alpha=0.1,aes(color=HA,group=HR)) +
  #geom_line(data=~filter(.,type=="Cleaned"),size=0.5,alpha=0.1,aes(color=HA,group=HR)) +
  geom_line(data=~filter(.,type=="Trend"),aes(color=HA,group=HR),size=0.75) +
  theme_bw() +
  scale_x_date(breaks="month",labels=function(d)strftime(d,"%b")) +
  theme(legend.position = "bottom") +
  full_labels(label_y,
              major_restriction_labels=c("2020-03-18"="Phase 1"),
              major_restrictions_y=label_y) +
  scale_color_manual(values=ha_colours) +
  ggrepel::geom_text_repel(data = ~filter(.,Date==max(Date),type=="Trend",count>=5),
                           aes(label=HR,color=HA),show.legend=FALSE,
                           nudge_x = 7,direction="y",size=3,hjust=0,
                           segment.color="black",segment.size = 0.25) +
  labs(title=paste0("Covid-19 daily new cases trend lines in British Columbia (up to ",strftime(max(data$Date),"%a %b %d"),")"),
       subtitle="Timeline of <b style='color:#A52A2A;'>closure</b> and <b style='color:#006400;'>reopening</b> events",
       x=NULL,y="Daily cases per 100k population",color=NULL,caption="MountainMath, Data: BCCDC, BC Stats") +
  theme(plot.subtitle = element_markdown()) +
  expand_limits(x=max(data$Date)+40)

g
#r<-graph_to_s3(g,"bccovid","hr-trend.png",width=knitr::opts_chunk$get('fig.width'),height=knitr::opts_chunk$get('fig.height'))
```

```{r hr-trend-2}
pop_data <- read_csv(here("data/hr_pop.csv")) %>%
  select(HR_UID=Region,HR=`Health Service Delivery Area`,Population=Total)


data <- get_british_columbia_hr_case_data() %>%
  rename(HA=`Health Authority`,HR=`Health Region`) %>%
  filter(!(HA %in% c("Out of Canada","All")),!(HR %in% c("All","Unknown"))) %>%
  filter(Date>=as.Date("2020-03-01")) %>%
  group_by(HR,HA) %>%
  mutate(Trend=extract_stl_trend_m(Cases+1),
         Seasonal=extract_stl_seasonal_m(Cases+1)) %>%
  mutate(Cleaned=Cases/Seasonal-1) %>%
  left_join(read_csv(here("data/ha_pop.csv")) %>%
              select(HA=`Health Authority`,HA_Population=Total), by="HA") %>%
  left_join(pop_data, by="HR") %>%
  mutate(Population=coalesce(Population,HA_Population)) %>%
  ungroup() %>%
  mutate(Cases_0=Cases,Trend_0=Trend,Cleand_0=Cleaned) %>%
  mutate_at(c("Cases","Cleaned","Trend"),function(d)d/.$Population*100000)

hr_colours <- data$HA %>% 
  unique() %>%
  lapply(function(ha){
    hrs <- data %>% filter(HA==ha) %>% pull(HR) %>% unique
    setNames(RColorBrewer::brewer.pal(length(hrs),"Dark2"),hrs)
  }) %>%
  unlist()


label_y <- max(data$Cases) * 0.9 

g <- data %>% 
  filter(!(HR %in% c("All","Unknown"))) %>%
  pivot_longer(c("Cases","Trend","Cleaned"),names_to="type",values_to="count") %>%
  ggplot(aes(x = Date, y = count)) + 
  #geom_point(data=~filter(.,type=="Cases"),size=0.5,alpha=0.1,aes(color=HA,group=HR)) +
  #geom_line(data=~filter(.,type=="Cleaned"),size=0.5,alpha=0.1,aes(color=HA,group=HR)) +
  restriction_markers(0.5,0.25) +
  geom_line(data=~filter(.,type=="Trend"),aes(color=HR,group=HR),size=0.75) +
  theme_bw() +
  facet_wrap("HA",scales="free_y",ncol=2) +
  scale_x_date(breaks="month",labels=function(d)strftime(d,"%b")) +
  theme(legend.position = "bottom") +
  # full_labels(label_y,
  #             major_restriction_labels=c("2020-03-18"="Phase 1"),
  #             major_restrictions_y=label_y) +
  scale_color_manual(values=hr_colours,guide=FALSE) +
  ggrepel::geom_text_repel(data = ~filter(.,Date==max(Date),type=="Trend"),#,count>=5),
                           aes(label=HR,color=HR),show.legend=FALSE,
                           nudge_x = 7,direction="y",size=2,hjust=0,
                           segment.color="black",segment.size = 0.25) +
  labs(title=paste0("Covid-19 daily new cases trend lines in British Columbia (up to ",strftime(max(data$Date),"%a %b %d"),")"),
       subtitle="Timeline of <b style='color:#A52A2A;'>closure</b> and <b style='color:#006400;'>reopening</b> events",
       x=NULL,y="Daily cases per 100k population",color=NULL,caption="MountainMath, Data: BCCDC, BC Stats") +
  theme(plot.subtitle = element_markdown()) +
  expand_limits(x=max(data$Date)+40)

g
#r<-graph_to_s3(g,"bccovid","hr-trend.png",width=knitr::opts_chunk$get('fig.width'),height=knitr::opts_chunk$get('fig.height'))
```


### Health Region geocoding problems
Health Authorities may lag in geocoding cases to Health Region geographies, which makes the above Health Region level graph difficult to interpret. This graph shows the share of cases in each Health Authority that were geocoded to Health Region geographies.

```{r hr-check}
data_u <- get_british_columbia_hr_case_data() %>%
  rename(HA=`Health Authority`,HR=`Health Region`) %>%
  filter(HA != "Out of Canada") 

pd <- data_u %>%
  filter(HA!="All") %>%
  left_join(data_u %>% 
              filter(HA=="All") %>% 
              select(Date,BC_Cases=Cases),
            by="Date") %>%
  left_join(data_u %>%
              filter(HR!="All") %>% 
              group_by(Date,HA) %>% 
              summarize(HR_sum=sum(Cases),.groups="drop"),
            by=c("Date","HA")) %>%
  mutate(Cases2=ifelse(HR=="All",Cases-HR_sum,Cases)) %>%
  mutate(share=Cases/HR_sum)

g <- pd %>% 
  filter(HR=="Unknown") %>%
  filter(Date>=as.Date("2020-07-01")) %>%
  group_by(HA) %>%
  arrange(Date) %>%
  filter(cumsum(Cases)>0) %>%
  ggplot(aes(x=Date,color=HA,group=HA)) +
  geom_point(aes(y=share),shape=21) +
  geom_line(aes(y=share)) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_y_continuous(labels = scales::percent) +
  scale_color_manual(values=ha_colours) +
  labs(title="Cases with missing Health Region level geocoding",
       x=NULL,y="Share of cases",
       color=NULL,caption="MountainMath, Data: BCCDC")

g
#r<-graph_to_s3(g,"bccovid","hr-check.png",width=knitr::opts_chunk$get('fig.width'),height=knitr::opts_chunk$get('fig.height'))
```

